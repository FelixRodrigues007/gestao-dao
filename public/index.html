<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiqPay DAO ‚Äî Treasury Command Center</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --void: #06080d;
  --abyss: #0c1018;
  --deep: #111722;
  --slate: #182030;
  --steel: #1f2b3d;
  --edge: #283650;
  --mist: #3a4d6e;
  --ash: #64748b;
  --silver: #94a3b8;
  --pearl: #cbd5e1;
  --white: #f1f5f9;
  --gold: #f0b90b;
  --gold-50: rgba(240,185,11,0.5);
  --gold-20: rgba(240,185,11,0.2);
  --gold-10: rgba(240,185,11,0.08);
  --red: #ff3b5c;
  --red-50: rgba(255,59,92,0.5);
  --red-20: rgba(255,59,92,0.15);
  --red-10: rgba(255,59,92,0.08);
  --green: #00e68a;
  --green-50: rgba(0,230,138,0.5);
  --green-20: rgba(0,230,138,0.15);
  --green-10: rgba(0,230,138,0.08);
  --blue: #4da6ff;
  --blue-20: rgba(77,166,255,0.15);
  --orange: #ff9f43;
  --orange-20: rgba(255,159,67,0.15);
  --purple: #a78bfa;
  --purple-20: rgba(167,139,250,0.15);
  --font: 'DM Sans', -apple-system, sans-serif;
  --mono: 'Space Mono', 'SF Mono', monospace;
  --r: 12px;
  --rs: 8px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:14px}
body{font-family:var(--font);background:var(--void);color:var(--pearl);min-height:100vh;overflow-x:hidden}

/* Ambient gradient */
body::after{content:'';position:fixed;top:-200px;right:-200px;width:600px;height:600px;background:radial-gradient(circle,rgba(240,185,11,0.04) 0%,transparent 70%);pointer-events:none;z-index:0}

.app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100vh}

/* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:52px;background:var(--abyss);border-bottom:1px solid var(--edge);position:sticky;top:0;z-index:100;backdrop-filter:blur(16px)}
.topbar-l{display:flex;align-items:center;gap:14px}
.logo{width:28px;height:28px;background:var(--gold);border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;color:var(--void)}
.brand{font-weight:700;font-size:14px;letter-spacing:-.3px}.brand b{color:var(--gold)}
.topbar-r{display:flex;align-items:center;gap:12px}
.conn-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.conn-dot.on{background:var(--green);box-shadow:0 0 8px var(--green-50)}
.conn-dot.off{background:var(--red);box-shadow:0 0 8px var(--red-50)}
.conn-dot.wait{background:var(--orange);animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.conn-text{font-family:var(--mono);font-size:11px;color:var(--ash)}
.top-btn{background:var(--steel);border:1px solid var(--edge);border-radius:6px;padding:5px 10px;color:var(--silver);cursor:pointer;font-size:13px;transition:.15s}
.top-btn:hover{border-color:var(--gold);color:var(--gold)}
.top-btn.active{background:var(--gold-10);border-color:var(--gold);color:var(--gold)}
.top-sep{width:1px;height:24px;background:var(--edge)}

/* ‚îÄ‚îÄ‚îÄ ALERT STRIP ‚îÄ‚îÄ‚îÄ */
.alert-strip{height:0;overflow:hidden;transition:height .4s ease;display:flex;align-items:center;gap:10px;padding:0 24px;font-size:12px;font-weight:600}
.alert-strip.show{height:36px}
.alert-strip.danger{background:linear-gradient(90deg,var(--red-20) 0%,transparent 80%);color:var(--red);border-bottom:1px solid var(--red-20)}
.alert-strip.warn{background:linear-gradient(90deg,var(--orange-20) 0%,transparent 80%);color:var(--orange);border-bottom:1px solid var(--orange-20)}
.alert-strip.ok{background:linear-gradient(90deg,var(--green-20) 0%,transparent 80%);color:var(--green);border-bottom:1px solid var(--green-20)}

/* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
.main{flex:1;display:grid;grid-template-columns:320px 1fr 340px;gap:0;overflow:hidden}
@media(max-width:1200px){.main{grid-template-columns:1fr;overflow-y:auto}.panel,.center,.sidebar{max-height:none}}

/* ‚îÄ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ‚îÄ */
.panel{background:var(--abyss);border-right:1px solid var(--edge);overflow-y:auto;padding:20px 18px}
.panel::-webkit-scrollbar{width:4px}.panel::-webkit-scrollbar-thumb{background:var(--edge);border-radius:2px}

.sect{margin-bottom:24px}
.sect-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.sect-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--ash)}
.sect-badge{font-family:var(--mono);font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700}
.sect-badge.live{background:var(--green-20);color:var(--green)}
.sect-badge.manual{background:var(--blue-20);color:var(--blue)}

.field{margin-bottom:16px}
.field-label{display:flex;align-items:center;justify-content:space-between;font-size:11px;font-weight:700;color:var(--ash);text-transform:uppercase;letter-spacing:.6px;margin-bottom:7px}
.field-val{font-family:var(--mono);color:var(--gold);font-size:11px}
.inp{width:100%;padding:9px 12px;background:var(--deep);border:1.5px solid var(--edge);border-radius:var(--rs);color:var(--white);font-family:var(--mono);font-size:13px;font-weight:700;transition:.2s}
.inp:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-10)}
.inp:disabled{opacity:.5;cursor:not-allowed}

/* Range */
input[type=range]{-webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:var(--steel);outline:none;margin:8px 0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--gold);cursor:pointer;border:3px solid var(--abyss);box-shadow:0 0 10px var(--gold-50)}
input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--gold);cursor:pointer;border:3px solid var(--abyss)}
.range-row{display:flex;justify-content:space-between;font-size:10px;color:var(--mist);font-family:var(--mono);margin-top:4px}

.divider{height:1px;background:var(--edge);margin:18px 0}

/* Buttons */
.btn{width:100%;padding:10px;border:none;border-radius:var(--rs);font-family:var(--font);font-size:12px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-gold{background:var(--gold);color:var(--void)}.btn-gold:hover{box-shadow:0 4px 20px var(--gold-50);transform:translateY(-1px)}
.btn-outline{background:transparent;border:1.5px solid var(--edge);color:var(--silver)}.btn-outline:hover{border-color:var(--gold);color:var(--gold)}
.btn-danger{background:var(--red-20);color:var(--red);border:1px solid rgba(255,59,92,.2)}.btn-danger:hover{background:rgba(255,59,92,.25)}
.btn-sm{padding:6px 10px;font-size:10px;width:auto}

/* Lock Card */
.lock-card{background:var(--deep);border:1.5px solid var(--edge);border-radius:var(--r);padding:14px;margin-bottom:12px;position:relative;overflow:hidden}
.lock-card.active{border-color:var(--gold);box-shadow:0 0 20px var(--gold-10)}
.lock-card.active::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--gold)}
.lock-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.lock-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--ash)}
.lock-toggle{background:var(--steel);border:1px solid var(--edge);border-radius:4px;padding:3px 8px;font-size:10px;font-weight:700;cursor:pointer;color:var(--silver);font-family:var(--mono);transition:.15s}
.lock-toggle.active{background:var(--gold-10);border-color:var(--gold);color:var(--gold)}
.lock-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.lock-row .inp{flex:1}
.lock-row .btn-sm{flex-shrink:0}
.lock-info{font-size:10px;color:var(--mist);font-family:var(--mono);line-height:1.5}
.lock-delta{font-family:var(--mono);font-size:13px;font-weight:700;margin-top:6px}
.lock-delta.up{color:var(--green)}
.lock-delta.down{color:var(--red)}

/* ‚îÄ‚îÄ‚îÄ CENTER ‚îÄ‚îÄ‚îÄ */
.center{overflow-y:auto;padding:20px 22px}
.center::-webkit-scrollbar{width:4px}.center::-webkit-scrollbar-thumb{background:var(--edge);border-radius:2px}

/* Metric Row */
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px}
.m-card{background:var(--abyss);border:1px solid var(--edge);border-radius:var(--r);padding:14px 16px;position:relative;overflow:hidden}
.m-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.m-card.c-gold::after{background:var(--gold)}.m-card.c-red::after{background:var(--red)}.m-card.c-green::after{background:var(--green)}.m-card.c-blue::after{background:var(--blue)}
.m-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--ash);margin-bottom:8px}
.m-val{font-family:var(--mono);font-size:20px;font-weight:700;letter-spacing:-.5px;line-height:1}
.m-sub{font-family:var(--mono);font-size:10px;color:var(--mist);margin-top:6px}
.m-tag{display:inline-flex;align-items:center;gap:3px;font-family:var(--mono);font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;margin-top:6px}
.m-tag.up{background:var(--green-20);color:var(--green)}.m-tag.down{background:var(--red-20);color:var(--red)}

/* Cards */
.card{background:var(--abyss);border:1px solid var(--edge);border-radius:var(--r);margin-bottom:16px;overflow:hidden}
.card-h{padding:12px 16px;border-bottom:1px solid var(--edge);display:flex;align-items:center;justify-content:space-between}
.card-t{font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px}
.card-b{padding:16px}

/* Health Bar */
.health-bar-wrap{margin-bottom:18px}
.health-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.health-score{font-family:var(--mono);font-size:28px;font-weight:700}
.health-label{font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px}
.health-track{width:100%;height:8px;background:var(--steel);border-radius:4px;overflow:hidden;position:relative}
.health-fill{height:100%;border-radius:4px;transition:width .6s ease,background .4s ease}
.health-zones{display:flex;justify-content:space-between;margin-top:6px;font-size:9px;color:var(--mist);font-family:var(--mono)}

/* Chart */
.chart-box{position:relative;height:260px}

/* Breakdown */
.bd-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--edge)}
.bd-row:last-child{border-bottom:none}
.bd-l{display:flex;align-items:center;gap:10px}
.bd-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.bd-dot.gold{background:var(--gold)}.bd-dot.green{background:var(--green)}.bd-dot.blue{background:var(--blue)}.bd-dot.red{background:var(--red)}
.bd-name{font-size:12px;font-weight:600}.bd-desc{font-size:10px;color:var(--mist);margin-top:1px}
.bd-val{font-family:var(--mono);font-size:13px;font-weight:700;text-align:right}
.bd-sub{font-size:10px;color:var(--mist);text-align:right;margin-top:1px;font-family:var(--mono)}

/* Scenario Table */
.s-table{width:100%;border-collapse:collapse}
.s-table th{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--mist);padding:10px 8px;text-align:left;border-bottom:1px solid var(--edge);background:var(--deep)}
.s-table td{font-family:var(--mono);font-size:11px;padding:9px 8px;border-bottom:1px solid rgba(40,54,80,.5)}
.s-table tr:hover td{background:rgba(240,185,11,.02)}
.s-table .current td{background:var(--gold-10);font-weight:700}
.risk-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;text-transform:uppercase;letter-spacing:.3px}
.risk-badge.safe{background:var(--green-20);color:var(--green)}
.risk-badge.caution{background:var(--orange-20);color:var(--orange)}
.risk-badge.danger{background:var(--red-20);color:var(--red)}
.risk-badge.liq{background:var(--red);color:#fff}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{background:var(--abyss);border-left:1px solid var(--edge);overflow-y:auto;display:flex;flex-direction:column}
.sidebar::-webkit-scrollbar{width:4px}.sidebar::-webkit-scrollbar-thumb{background:var(--edge);border-radius:2px}

.sb-section{padding:16px;border-bottom:1px solid var(--edge)}
.sb-section:last-child{border-bottom:none;flex:1;display:flex;flex-direction:column}

.sb-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ash);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.sb-count{font-family:var(--mono);font-size:10px;background:var(--steel);padding:2px 6px;border-radius:4px}

/* Mini Kline */
.kline-wrap{height:120px;position:relative}
.kline-info{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
.kline-stat{font-family:var(--mono);font-size:10px}
.kline-stat span{color:var(--mist)}

/* 24h stats */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.mini-stat{background:var(--deep);border-radius:var(--rs);padding:10px 12px}
.mini-stat-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--mist);margin-bottom:4px}
.mini-stat-val{font-family:var(--mono);font-size:13px;font-weight:700}

/* Alert Log */
.alert-log{flex:1;overflow-y:auto;max-height:400px}
.alert-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid rgba(40,54,80,.4);animation:slideIn .3s ease}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.alert-item:last-child{border-bottom:none}
.a-dot{width:6px;height:6px;border-radius:50%;margin-top:5px;flex-shrink:0}
.a-dot.danger{background:var(--red);box-shadow:0 0 6px var(--red-50)}.a-dot.warn{background:var(--orange)}.a-dot.ok{background:var(--green)}.a-dot.info{background:var(--blue)}
.a-body{flex:1;min-width:0}
.a-msg{font-size:11px;line-height:1.5;color:var(--silver)}
.a-time{font-family:var(--mono);font-size:9px;color:var(--mist);margin-top:3px}

.empty-state{text-align:center;padding:30px 0;color:var(--mist);font-size:11px}

/* ‚îÄ‚îÄ‚îÄ TOOLTIPS ‚îÄ‚îÄ‚îÄ */
.tip-wrap{position:relative;display:inline-flex}
.tip-btn{width:18px;height:18px;border-radius:50%;background:var(--steel);border:1px solid var(--edge);color:var(--mist);font-size:10px;font-weight:700;cursor:help;display:inline-flex;align-items:center;justify-content:center;margin-left:6px;transition:.2s;flex-shrink:0;font-family:var(--font)}
.tip-btn:hover{background:var(--gold-10);border-color:var(--gold);color:var(--gold)}
.tip-box{visibility:hidden;opacity:0;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);width:280px;padding:12px 14px;background:var(--slate);border:1.5px solid var(--gold-20);border-radius:var(--rs);font-size:11px;line-height:1.6;color:var(--silver);box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:100;pointer-events:none;transition:.2s}
.tip-box::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--slate)}
.tip-wrap:hover .tip-box{visibility:visible;opacity:1}
.tip-box strong{color:var(--gold);font-weight:700}
.tip-box em{color:var(--orange);font-style:normal}

/* ‚îÄ‚îÄ‚îÄ SIMULATOR ‚îÄ‚îÄ‚îÄ */
.sim-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.sim-actions{display:flex;gap:8px;flex-wrap:wrap}
.sim-grid{display:grid;grid-template-columns:1fr;gap:0;margin-top:12px}
.sim-row{display:grid;grid-template-columns:120px 90px 100px 110px 100px 100px 90px 40px;gap:0;align-items:center;border-bottom:1px solid var(--edge);transition:background .15s}
.sim-row:hover{background:rgba(240,185,11,.02)}
.sim-row.sim-head-row{background:var(--deep);position:sticky;top:0;z-index:2}
.sim-row.sim-head-row .sim-cell{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--mist);padding:10px 10px}
.sim-cell{padding:10px 10px;font-family:var(--mono);font-size:11px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sim-inp{width:100%;padding:7px 8px;background:var(--steel);border:1.5px solid var(--edge);border-radius:5px;color:var(--white);font-family:var(--mono);font-size:12px;font-weight:700;transition:.15s;text-align:right}
.sim-inp:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px var(--gold-10)}
.sim-inp.usdt-inp:focus{border-color:var(--cyan);box-shadow:0 0 0 2px rgba(0,210,255,.1)}
.sim-remove{background:none;border:none;color:var(--mist);cursor:pointer;font-size:14px;padding:4px;border-radius:4px;transition:.15s}
.sim-remove:hover{color:var(--red);background:var(--red-10)}
.sim-row.positive{background:rgba(0,230,138,.03)}.sim-row.negative{background:rgba(255,59,92,.03)}
.sim-exposure{font-weight:700;font-size:12px}
.sim-exposure.up{color:var(--green)}.sim-exposure.down{color:var(--red)}.sim-exposure.neutral{color:var(--ash)}
.sim-ltv{font-weight:700}.sim-ltv.safe{color:var(--green)}.sim-ltv.caution{color:var(--orange)}.sim-ltv.danger{color:var(--red)}
.sim-chart-wrap{height:380px;margin-top:16px;position:relative}
.sim-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:16px}
.sim-sum-card{background:var(--deep);border-radius:var(--rs);padding:12px 14px;border-top:2px solid}
.sim-sum-card.c1{border-color:var(--gold)}.sim-sum-card.c2{border-color:var(--red)}.sim-sum-card.c3{border-color:var(--green)}.sim-sum-card.c4{border-color:var(--purple)}
.sim-sum-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--mist);margin-bottom:6px}
.sim-sum-val{font-family:var(--mono);font-size:16px;font-weight:700}
.sim-presets{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.sim-preset{padding:5px 10px;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;border:1px solid var(--edge);background:var(--steel);color:var(--silver);font-family:var(--mono);transition:.15s}
.sim-preset:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-10)}
@media(max-width:1200px){.sim-row{grid-template-columns:100px 80px 90px 100px 90px 90px 80px 36px}.sim-summary{grid-template-columns:1fr 1fr}}
@media(max-width:768px){.sim-row{grid-template-columns:90px 70px 1fr 1fr 40px}.sim-row .sim-cell:nth-child(3),.sim-row .sim-cell:nth-child(5),.sim-row .sim-cell:nth-child(6){display:none}.sim-summary{grid-template-columns:1fr}}

/* Responsive */
@media(max-width:1200px){
  .main{grid-template-columns:1fr;height:auto}
  .panel,.sidebar{border:none;border-bottom:1px solid var(--edge)}
  .metrics{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-l">
      <div class="logo">L</div>
      <div class="brand"><b>LiqPay</b> Treasury</div>
    </div>
    <div class="topbar-r">
      <div class="conn-dot wait" id="connDot"></div>
      <span class="conn-text" id="connText">Conectando...</span>
      <div class="top-sep"></div>
      <button class="top-btn" id="btnSound" title="Alertas sonoros">üîî</button>
      <button class="top-btn" id="btnAutoRefresh" title="Auto-refresh a cada 10s">‚ü≥ Auto</button>
      <div class="top-sep"></div>
      <span class="conn-text" id="lastUpdate">--</span>
    </div>
  </div>

  <!-- ALERT STRIP -->
  <div class="alert-strip" id="alertStrip"><span id="stripIcon"></span><span id="stripText"></span></div>

  <!-- MAIN 3-COL -->
  <div class="main">
    <!-- ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel">
      <div class="sect">
        <div class="sect-head">
          <span class="sect-title">Cota√ß√µes Bybit</span>
          <span class="sect-badge live" id="priceBadge">LIVE</span>
        </div>
        <button class="btn btn-gold" id="btnFetch" onclick="fetchAllPrices()">‚ö° Buscar Cota√ß√µes Agora</button>
        <div style="height:10px"></div>

        <div class="field">
          <div class="field-label"><span>BTC / USDT</span><span class="field-val" id="fBtc">--</span></div>
          <input type="number" class="inp" id="inBtc" value="108000" step="100">
        </div>
        <div class="field">
          <div class="field-label"><span>USDT / BRL</span><span class="field-val" id="fUsdt">--</span></div>
          <input type="number" class="inp" id="inUsdt" value="5.75" step="0.01">
        </div>
      </div>

      <div class="divider"></div>

      <div class="sect">
        <div class="sect-head"><span class="sect-title">Empr√©stimo</span></div>
        <div class="field">
          <div class="field-label"><span>Valor (BRL)</span><span class="field-val" id="fLoan">--</span></div>
          <input type="number" class="inp" id="inLoan" value="250000" step="10000">
        </div>
        <div class="field">
          <div class="field-label"><span>LTV Target</span><span class="field-val" id="fLtv">60%</span></div>
          <input type="range" id="inLtv" min="30" max="85" step="1" value="60">
          <div class="range-row"><span>30% Seguro</span><span>85% Risco</span></div>
        </div>

        <div class="divider" style="margin:12px 0"></div>
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ash);margin-bottom:10px;display:flex;align-items:center;gap:6px">üí∞ Juros Bybit<span style="font-size:8px;padding:2px 5px;background:var(--gold-10);color:var(--gold);border-radius:3px">NOVO</span><span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box">Configura os <strong>juros do empr√©stimo Bybit</strong>. <em>Flex√≠vel</em> = juros compostos por hora (muda a cada hora). <em>Fixo</em> = juros simples por prazo definido (7, 30, 90 ou 180 dias). Esses juros afetam TODOS os c√°lculos do dashboard.</span></span></div>

        <div class="field">
          <div class="field-label"><span>Taxa Anual (APR %)</span><span class="field-val" id="fApr">--</span></div>
          <input type="number" class="inp" id="inApr" value="12" step="0.1" min="0" max="100">
        </div>
        <div class="field">
          <div class="field-label"><span>Prazo (dias)</span><span class="field-val" id="fDays">--</span></div>
          <input type="number" class="inp" id="inDays" value="90" step="1" min="1" max="365">
        </div>
        <div class="field">
          <div class="field-label"><span>Tipo</span></div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-sm" id="btnFlexible" onclick="setLoanType('flexible')" style="flex:1;background:var(--gold-10);border:1px solid var(--gold);color:var(--gold)">Flex√≠vel</button>
            <button class="btn btn-sm" id="btnFixed" onclick="setLoanType('fixed')" style="flex:1;background:var(--steel);border:1px solid var(--edge);color:var(--silver)">Fixo</button>
          </div>
        </div>

        <!-- Interest Preview -->
        <div style="background:var(--deep);border:1px solid var(--edge);border-radius:var(--rs);padding:10px 12px;margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:10px;color:var(--mist)">Juros Total</span><span style="font-family:var(--mono);font-size:12px;font-weight:700;color:var(--orange)" id="prevInterest">--</span></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:10px;color:var(--mist)">D√≠vida Total (Principal + Juros)</span><span style="font-family:var(--mono);font-size:12px;font-weight:700;color:var(--red)" id="prevDebt">--</span></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:10px;color:var(--mist)">Custo por Hora</span><span style="font-family:var(--mono);font-size:10px;color:var(--ash)" id="prevHourly">--</span></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:10px;color:var(--mist)">Custo por Dia</span><span style="font-family:var(--mono);font-size:10px;color:var(--ash)" id="prevDaily">--</span></div>
          <div style="display:flex;justify-content:space-between"><span style="font-size:10px;color:var(--mist)">Liquida√ß√£o Bybit (92% LTV)</span><span style="font-family:var(--mono);font-size:11px;font-weight:700;color:var(--red)" id="prevLiqReal">--</span></div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- PRICE LOCKS -->
      <div class="sect">
        <div class="sect-head"><span class="sect-title">üîí Travas de Pre√ßo<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box"><strong>Trava um pre√ßo de refer√™ncia</strong> para BTC e USDT. Quando o pre√ßo real desviar al√©m do % configurado, o dashboard emite <em>alerta sonoro e visual</em>. √ötil para monitorar enquanto n√£o est√° olhando.</span></span></span></div>

        <div class="lock-card" id="lockBtcCard">
          <div class="lock-head">
            <span class="lock-title">Trava BTC/USDT</span>
            <button class="lock-toggle" id="lockBtcBtn" onclick="toggleLock('btc')">OFF</button>
          </div>
          <div class="lock-row">
            <input type="number" class="inp" id="lockBtcPrice" placeholder="Pre√ßo travado">
            <button class="btn btn-sm btn-outline" onclick="lockCurrent('btc')">Travar Atual</button>
          </div>
          <div class="lock-info">Alerta se desviar ¬±<input type="number" class="inp" id="lockBtcPct" value="5" style="width:50px;display:inline;padding:4px 6px;font-size:11px;text-align:center">% do pre√ßo travado</div>
          <div class="lock-delta" id="lockBtcDelta"></div>
        </div>

        <div class="lock-card" id="lockUsdtCard">
          <div class="lock-head">
            <span class="lock-title">Trava USDT/BRL</span>
            <button class="lock-toggle" id="lockUsdtBtn" onclick="toggleLock('usdt')">OFF</button>
          </div>
          <div class="lock-row">
            <input type="number" class="inp" id="lockUsdtPrice" placeholder="Pre√ßo travado">
            <button class="btn btn-sm btn-outline" onclick="lockCurrent('usdt')">Travar Atual</button>
          </div>
          <div class="lock-info">Alerta se desviar ¬±<input type="number" class="inp" id="lockUsdtPct" value="3" style="width:50px;display:inline;padding:4px 6px;font-size:11px;text-align:center">% do pre√ßo travado</div>
          <div class="lock-delta" id="lockUsdtDelta"></div>
        </div>

        <div class="lock-card" id="lockColCard">
          <div class="lock-head">
            <span class="lock-title">Trava LTV M√°ximo</span>
            <button class="lock-toggle" id="lockColBtn" onclick="toggleLock('col')">OFF</button>
          </div>
          <div class="lock-row">
            <input type="number" class="inp" id="lockColMax" value="70" placeholder="LTV m√°ximo %">
            <span style="font-size:11px;color:var(--ash)">%</span>
          </div>
          <div class="lock-info">Alerta se LTV efetivo ultrapassar este limite</div>
          <div class="lock-delta" id="lockColDelta"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CENTER ‚ïê‚ïê‚ïê -->
    <div class="center">
      <!-- Health Bar -->
      <div class="health-bar-wrap">
        <div class="health-top">
          <div>
            <span style="font-size:10px;color:var(--ash);font-weight:700;text-transform:uppercase;letter-spacing:1px">Sa√∫de do Colateral</span>
            <span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box"><strong>Sa√∫de do Colateral</strong> mede qu√£o segura est√° sua posi√ß√£o de 0 a 100. Considera o <em>LTV efetivo</em> (incluindo juros), a dist√¢ncia at√© a liquida√ß√£o e a margem de seguran√ßa. Abaixo de 40 = perigo, 40‚Äì70 = aten√ß√£o, acima de 70 = seguro.</span></span>
            <span class="health-score" id="healthScore">--</span>
          </div>
          <span class="health-label" id="healthLabel">--</span>
        </div>
        <div class="health-track"><div class="health-fill" id="healthFill" style="width:0%"></div></div>
        <div class="health-zones"><span>‚ö† Perigo</span><span>Aten√ß√£o</span><span>Seguro ‚úì</span></div>
      </div>

      <!-- Metrics -->
      <div class="metrics">
        <div class="m-card c-gold">
          <div class="m-label">BTC Necess√°rio<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box">Quantidade de <strong>BTC que a Bybit exige como colateral</strong> para manter o empr√©stimo no LTV target configurado. Calculado como: <em>D√≠vida USDT √∑ (LTV √ó Pre√ßo BTC)</em>.</span></span></div>
          <div class="m-val" id="mBtc">--</div>
          <div class="m-sub" id="mBtcSub">--</div>
        </div>
        <div class="m-card c-green">
          <div class="m-label">Colateral USDT<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box">Valor do seu colateral em <strong>USDT (d√≥lar digital)</strong>. √â o BTC travado √ó pre√ßo BTC/USDT atual. A Bybit calcula liquida√ß√£o nesta moeda.</span></span></div>
          <div class="m-val" id="mUsdt">--</div>
          <div class="m-sub" id="mUsdtSub">--</div>
        </div>
        <div class="m-card c-blue">
          <div class="m-label">Colateral BRL<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box">Valor do colateral convertido para <strong>Reais</strong>. Oscila com BTC e c√¢mbio do d√≥lar. Este √© o valor "real" que protege seu empr√©stimo.</span></span></div>
          <div class="m-val" id="mBrl">--</div>
          <div class="m-sub" id="mBrlSub">--</div>
        </div>
        <div class="m-card c-red">
          <div class="m-label">Liquida√ß√£o<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box"><strong>Pre√ßo de liquida√ß√£o Bybit.</strong> Se o BTC cair at√© este valor, a Bybit vende seu colateral automaticamente (LTV 92%). Inclui juros acumulados. <em>Margin call acontece no LTV 85%.</em></span></span></div>
          <div class="m-val" id="mLiq">--</div>
          <div class="m-sub" id="mLiqSub">--</div>
        </div>
      </div>

      <!-- Risk Chart -->
      <div class="card">
        <div class="card-h">
          <span class="card-t">‚ö° Mapa de Risco<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box">Gr√°fico de rosca mostrando a <strong>propor√ß√£o entre d√≠vida e colateral</strong>. Verde = margem de seguran√ßa (sobra). Vermelho = d√≠vida. Quanto mais verde, mais seguro.</span></span></span>
          <span style="font-family:var(--mono);font-size:10px;color:var(--mist)" id="riskInfo">--</span>
        </div>
        <div class="card-b"><div class="chart-box"><canvas id="riskChart"></canvas></div></div>
      </div>

      <!-- Breakdown -->
      <div class="card">
        <div class="card-h"><span class="card-t">üí∞ Breakdown<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box"><strong>Composi√ß√£o detalhada</strong> da posi√ß√£o: BTC bloqueado na Bybit, valor em USDT e BRL, empr√©stimo + juros, e a <em>margem de seguran√ßa</em> (diferen√ßa entre colateral e d√≠vida).</span></span></span></div>
        <div class="card-b">
          <div class="bd-row"><div class="bd-l"><div class="bd-dot gold"></div><div><div class="bd-name">Bitcoin Colateral</div><div class="bd-desc">Bloqueado Bybit</div></div></div><div><div class="bd-val" id="bdBtc">--</div><div class="bd-sub" id="bdBtcS">--</div></div></div>
          <div class="bd-row"><div class="bd-l"><div class="bd-dot green"></div><div><div class="bd-name">Equivalente USDT</div><div class="bd-desc">BTC √ó cota√ß√£o</div></div></div><div><div class="bd-val" id="bdUsdt">--</div><div class="bd-sub" id="bdUsdtS">--</div></div></div>
          <div class="bd-row"><div class="bd-l"><div class="bd-dot blue"></div><div><div class="bd-name">Equivalente BRL</div><div class="bd-desc">USDT √ó c√¢mbio</div></div></div><div><div class="bd-val" id="bdBrl">--</div><div class="bd-sub" id="bdBrlS">--</div></div></div>
          <div class="bd-row"><div class="bd-l"><div class="bd-dot red"></div><div><div class="bd-name">Buffer Seguran√ßa</div><div class="bd-desc">Margem at√© liquida√ß√£o</div></div></div><div><div class="bd-val" id="bdBuf">--</div><div class="bd-sub" id="bdBufS">--</div></div></div>
        </div>
      </div>

      <!-- Scenario Table -->
      <div class="card">
        <div class="card-h"><span class="card-t">üéØ Stress Test<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box"><strong>Teste de estresse</strong> com cen√°rios pr√©-definidos de queda do BTC (-10% a -50%). Mostra quanto BTC seria necess√°rio em cada cen√°rio e o <em>LTV efetivo na Bybit</em>, incluindo juros.</span></span></span></div>
        <div class="card-b" style="padding:0;overflow-x:auto">
          <table class="s-table">
            <thead><tr><th>Cen√°rio</th><th>BTC/USDT</th><th>BTC/BRL</th><th>BTC Col.</th><th>LTV Efetivo</th><th>Queda M√°x</th><th>Status</th></tr></thead>
            <tbody id="scenBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Scenario Chart merged into simulator below -->

      <!-- ‚ïê‚ïê‚ïê PRICE SIMULATOR v2 ‚Äî Cross Scenarios ‚ïê‚ïê‚ïê -->
      <div class="card" id="simCard">
        <div class="card-h">
          <span class="card-t">üß™ Simulador de Cen√°rios<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box"><strong>Crie seus pr√≥prios cen√°rios</strong> variando BTC e D√≥lar simultaneamente. Veja quantos BTCs precisa, o LTV real na Bybit e o valor em Reais. Use os <em>presets prontos</em> ou digite valores manualmente. Os juros s√£o inclu√≠dos automaticamente.</span></span></span>
          <span style="font-family:var(--mono);font-size:10px;color:var(--mist)">BTC √ó D√≥lar ¬∑ Cruzado</span>
        </div>
        <div class="card-b">
          <div style="font-size:11px;color:var(--silver);line-height:1.6;margin-bottom:14px">
            Simule <strong style="color:var(--gold)">diferentes pre√ßos de BTC e D√≥lar</strong> simultaneamente.
            Veja quantos BTCs voc√™ precisa para manter a posi√ß√£o, o LTV real na Bybit, e o valor em Reais.
          </div>

          <!-- ADD SCENARIO ZONE -->
          <div style="background:var(--deep);border:1.5px solid var(--edge);border-radius:var(--r);padding:16px;margin-bottom:16px">
            
            <!-- Manual Input -->
            <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px">
              <div style="flex:1;min-width:130px">
                <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--mist);margin-bottom:4px">BTC/USDT</div>
                <input type="number" class="inp" id="simInBtc" placeholder="67000" style="font-size:13px;padding:8px 10px">
              </div>
              <div style="flex:1;min-width:130px">
                <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--mist);margin-bottom:4px">USDT/BRL</div>
                <input type="number" class="inp" id="simInUsdt" placeholder="5.24" step="0.01" style="font-size:13px;padding:8px 10px">
              </div>
              <button class="btn btn-sm btn-gold" onclick="simAddManual()" style="white-space:nowrap;padding:9px 16px">+ Adicionar</button>
            </div>

            <!-- Quick Presets -->
            <div style="margin-bottom:10px">
              <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--mist);margin-bottom:6px">Cen√°rios Prontos</div>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                <button class="sim-preset" onclick="simLoadPreset('bearUsdUp')">üêªüíµ BTC‚Üì D√≥lar‚Üë</button>
                <button class="sim-preset" onclick="simLoadPreset('bearUsdDown')">üêªüìâ BTC‚Üì D√≥lar‚Üì</button>
                <button class="sim-preset" onclick="simLoadPreset('bullUsdUp')">üöÄüíµ BTC‚Üë D√≥lar‚Üë</button>
                <button class="sim-preset" onclick="simLoadPreset('bullUsdDown')">üöÄüìâ BTC‚Üë D√≥lar‚Üì</button>
                <button class="sim-preset" onclick="simLoadPreset('matrix')">üî¢ Matriz Completa</button>
                <button class="sim-preset" onclick="simLoadPreset('worst')">üíÄ Pior Caso</button>
                <button class="sim-preset" onclick="simLoadPreset('best')">üåü Melhor Caso</button>
              </div>
            </div>

            <!-- BTC Quick % -->
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:8px">
              <span style="font-size:9px;color:var(--gold);font-weight:700;width:50px">BTC:</span>
              <button class="sim-preset" onclick="simAddBtcPct(-30)">-30%</button>
              <button class="sim-preset" onclick="simAddBtcPct(-20)">-20%</button>
              <button class="sim-preset" onclick="simAddBtcPct(-10)">-10%</button>
              <button class="sim-preset" style="border-color:var(--gold);color:var(--gold);cursor:default">ATUAL</button>
              <button class="sim-preset" onclick="simAddBtcPct(10)">+10%</button>
              <button class="sim-preset" onclick="simAddBtcPct(20)">+20%</button>
              <button class="sim-preset" onclick="simAddBtcPct(50)">+50%</button>
            </div>
            <!-- USDT Quick % -->
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
              <span style="font-size:9px;color:var(--cyan);font-weight:700;width:50px">USDT:</span>
              <button class="sim-preset" onclick="simAddUsdtPct(-15)">-15%</button>
              <button class="sim-preset" onclick="simAddUsdtPct(-10)">-10%</button>
              <button class="sim-preset" onclick="simAddUsdtPct(-5)">-5%</button>
              <button class="sim-preset" style="border-color:var(--cyan);color:var(--cyan);cursor:default">ATUAL</button>
              <button class="sim-preset" onclick="simAddUsdtPct(5)">+5%</button>
              <button class="sim-preset" onclick="simAddUsdtPct(10)">+10%</button>
              <button class="sim-preset" onclick="simAddUsdtPct(20)">+20%</button>
            </div>
          </div>

          <!-- Controls -->
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
            <span style="font-size:10px;color:var(--mist)" id="simCount">0 cen√°rios</span>
            <div style="flex:1"></div>
            <button class="btn btn-sm btn-outline" onclick="simReset()" style="color:var(--red);border-color:rgba(255,59,92,.3)">‚úï Limpar Tudo</button>
          </div>

          <!-- Simulator Table -->
          <div style="overflow-x:auto">
            <div class="sim-grid">
              <div class="sim-row sim-head-row" style="grid-template-columns:120px 90px 100px 110px 100px 100px 90px 40px">
                <div class="sim-cell">BTC/USDT</div>
                <div class="sim-cell">USDT/BRL</div>
                <div class="sim-cell">BTC/BRL</div>
                <div class="sim-cell">BTC Necess√°rio</div>
                <div class="sim-cell">Œî vs Atual</div>
                <div class="sim-cell">Colateral BRL</div>
                <div class="sim-cell">LTV Bybit</div>
                <div class="sim-cell"></div>
              </div>
              <div id="simRows"></div>
            </div>
          </div>

          <!-- Summary Cards -->
          <div class="sim-summary">
            <div class="sim-sum-card c1"><div class="sim-sum-label">Posi√ß√£o Atual</div><div class="sim-sum-val" id="simCurrent">--</div><div style="font-size:9px;color:var(--mist);margin-top:2px" id="simCurrentSub">--</div></div>
            <div class="sim-sum-card c3"><div class="sim-sum-label">Melhor Cen√°rio</div><div class="sim-sum-val" id="simBest">--</div><div style="font-size:9px;color:var(--mist);margin-top:2px" id="simBestSub">--</div></div>
            <div class="sim-sum-card c2"><div class="sim-sum-label">Pior Cen√°rio</div><div class="sim-sum-val" id="simWorst">--</div><div style="font-size:9px;color:var(--mist);margin-top:2px" id="simWorstSub">--</div></div>
            <div class="sim-sum-card c4"><div class="sim-sum-label">Liquida√ß√£o Bybit</div><div class="sim-sum-val" id="simLiqPrice">--</div><div style="font-size:9px;color:var(--mist);margin-top:2px">LTV 92% ¬∑ BTC/USDT</div></div>
          </div>

          <!-- Consolidated Chart ‚Äî Power BI Style -->
          <div style="background:var(--deep);border:1.5px solid var(--edge);border-radius:var(--r);padding:16px;margin-top:16px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
              <div>
                <div style="font-size:12px;font-weight:700;color:var(--white)">üìä Painel Consolidado de Cen√°rios<span class="tip-wrap"><span class="tip-btn">?</span><span class="tip-box"><strong>Gr√°fico unificado</strong> que combina seus cen√°rios simulados + stress test em uma √∫nica visualiza√ß√£o. Barras = BTC necess√°rio. Linha roxa = LTV Bybit. <em>Linhas pontilhadas</em> marcam os limites de Margin Call (85%) e Liquida√ß√£o (92%).</span></span></div>
                <div style="font-size:10px;color:var(--mist);margin-top:2px">Simulador + Stress Test ¬∑ Dual Axis ¬∑ LTV Bybit</div>
              </div>
              <div style="display:flex;gap:4px">
                <span style="display:inline-flex;align-items:center;gap:4px;font-size:9px;color:var(--mist)"><span style="width:10px;height:10px;border-radius:2px;background:var(--gold)"></span>Simulado</span>
                <span style="display:inline-flex;align-items:center;gap:4px;font-size:9px;color:var(--mist)"><span style="width:10px;height:10px;border-radius:2px;background:var(--blue)"></span>Stress Test</span>
                <span style="display:inline-flex;align-items:center;gap:4px;font-size:9px;color:var(--mist)"><span style="width:10px;height:3px;background:var(--purple)"></span>LTV %</span>
              </div>
            </div>
            <div class="sim-chart-wrap"><canvas id="simChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê RIGHT SIDEBAR ‚ïê‚ïê‚ïê -->
    <div class="sidebar">
      <!-- Mini Kline -->
      <div class="sb-section">
        <div class="sb-title">BTC/USDT 24h<span class="sect-badge live">BYBIT</span></div>
        <div class="kline-wrap"><canvas id="klineChart"></canvas></div>
        <div class="kline-info">
          <div class="kline-stat"><span>H </span><span id="kH" style="color:var(--green)">--</span></div>
          <div class="kline-stat"><span>L </span><span id="kL" style="color:var(--red)">--</span></div>
          <div class="kline-stat"><span>Vol </span><span id="kV" style="color:var(--pearl)">--</span></div>
          <div class="kline-stat"><span>24h </span><span id="k24" style="color:var(--pearl)">--</span></div>
        </div>
      </div>

      <!-- 24h Stats -->
      <div class="sb-section">
        <div class="sb-title">Resumo 24h</div>
        <div class="stats-grid">
          <div class="mini-stat"><div class="mini-stat-label">BTC/BRL</div><div class="mini-stat-val" id="sBtcBrl">--</div></div>
          <div class="mini-stat"><div class="mini-stat-label">Spread USDT</div><div class="mini-stat-val" id="sSpread">--</div></div>
          <div class="mini-stat"><div class="mini-stat-label">Queda M√°x</div><div class="mini-stat-val" id="sMaxDrop">--</div></div>
          <div class="mini-stat"><div class="mini-stat-label">Buffer</div><div class="mini-stat-val" id="sBuffer">--</div></div>
        </div>
      </div>

      <!-- Alert Log -->
      <div class="sb-section">
        <div class="sb-title">Alertas<span class="sb-count" id="aCount">0</span></div>
        <button class="btn btn-outline" style="margin-bottom:10px;font-size:10px" onclick="clearAlerts()">Limpar</button>
        <div class="alert-log" id="alertLog"><div class="empty-state">Aguardando dados...</div></div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  alerts: [],
  sound: false,
  autoRefresh: false,
  autoTimer: null,
  ws: null,
  wsRetries: 0,
  locks: { btc: false, usdt: false, col: false },
  prev: { health: null, btcPrice: null, usdtPrice: null },
  klineData: [],
  ticker24: { high: 0, low: 0, vol: 0, pct: 0 }
};

const $ = id => document.getElementById(id);
const fmt = (v,d=2) => v.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d});
const fmtK = v => v>=1e6?(v/1e6).toFixed(2)+'M':v>=1e3?(v/1e3).toFixed(1)+'k':v.toFixed(2);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BYBIT REST API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BYBIT_BASE = 'https://api.bybit.com/v5/market';

async function fetchTicker(symbol) {
  const r = await fetch(`${BYBIT_BASE}/tickers?category=spot&symbol=${symbol}`);
  const d = await r.json();
  if (d.retCode !== 0) throw new Error(d.retMsg);
  return d.result.list[0];
}

async function fetchKline(symbol, interval='60', limit=24) {
  const r = await fetch(`${BYBIT_BASE}/kline?category=spot&symbol=${symbol}&interval=${interval}&limit=${limit}`);
  const d = await r.json();
  if (d.retCode !== 0) throw new Error(d.retMsg);
  return d.result.list; // [ [timestamp, open, high, low, close, volume, turnover], ... ]
}

async function fetchAllPrices() {
  const btn = $('btnFetch');
  btn.textContent = '‚è≥ Buscando...';
  btn.style.opacity = '.6';

  try {
    // BTC/USDT
    const btcTicker = await fetchTicker('BTCUSDT');
    $('inBtc').value = parseFloat(btcTicker.lastPrice).toFixed(2);
    S.ticker24.high = parseFloat(btcTicker.highPrice24h);
    S.ticker24.low = parseFloat(btcTicker.lowPrice24h);
    S.ticker24.vol = parseFloat(btcTicker.volume24h);
    S.ticker24.pct = parseFloat(btcTicker.price24hPcnt) * 100;

    // USDT/BRL
    try {
      const usdtTicker = await fetchTicker('USDTBRL');
      $('inUsdt').value = parseFloat(usdtTicker.lastPrice).toFixed(2);
    } catch(e) {
      addAlert('warn', 'Par USDT/BRL n√£o dispon√≠vel na Bybit Spot. Use valor manual.');
    }

    // Kline 24h
    try {
      const klines = await fetchKline('BTCUSDT', '60', 24);
      S.klineData = klines.reverse(); // oldest first
      updateKlineChart();
    } catch(e) {}

    setConnection('on', 'Bybit API OK');
    addAlert('ok', `Cota√ß√µes atualizadas ‚Äî BTC ‚ÇÆ${fmt(parseFloat(btcTicker.lastPrice))} | ${new Date().toLocaleTimeString('pt-BR')}`);
    $('lastUpdate').textContent = new Date().toLocaleTimeString('pt-BR');

    btn.textContent = '‚úÖ Atualizado!';
    setTimeout(() => { btn.textContent = '‚ö° Buscar Cota√ß√µes Agora'; btn.style.opacity = '1'; }, 2000);
  } catch(e) {
    setConnection('off', 'Erro API');
    addAlert('danger', `Falha ao buscar Bybit: ${e.message}. Use valores manuais.`);
    btn.textContent = '‚ùå Erro';
    setTimeout(() => { btn.textContent = '‚ö° Buscar Cota√ß√µes Agora'; btn.style.opacity = '1'; }, 3000);
  }

  calculateAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BYBIT WEBSOCKET (Public Spot Ticker)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectWebSocket() {
  if (S.ws && S.ws.readyState <= 1) return;

  try {
    setConnection('wait', 'Conectando WebSocket...');
    S.ws = new WebSocket('wss://stream.bybit.com/v5/public/spot');

    S.ws.onopen = () => {
      S.wsRetries = 0;
      setConnection('on', 'WebSocket Live');
      $('priceBadge').textContent = 'WS LIVE';
      $('priceBadge').className = 'sect-badge live';
      // Subscribe to BTC ticker
      S.ws.send(JSON.stringify({ op: 'subscribe', args: ['tickers.BTCUSDT'] }));
      // Try USDT/BRL too
      S.ws.send(JSON.stringify({ op: 'subscribe', args: ['tickers.USDTBRL'] }));
    };

    S.ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.topic === 'tickers.BTCUSDT' && msg.data) {
          const price = parseFloat(msg.data.lastPrice);
          if (price > 0) {
            $('inBtc').value = price.toFixed(2);
            if (msg.data.highPrice24h) S.ticker24.high = parseFloat(msg.data.highPrice24h);
            if (msg.data.lowPrice24h) S.ticker24.low = parseFloat(msg.data.lowPrice24h);
            if (msg.data.volume24h) S.ticker24.vol = parseFloat(msg.data.volume24h);
            if (msg.data.price24hPcnt) S.ticker24.pct = parseFloat(msg.data.price24hPcnt) * 100;
            $('lastUpdate').textContent = new Date().toLocaleTimeString('pt-BR');
            calculateAll();
          }
        }
        if (msg.topic === 'tickers.USDTBRL' && msg.data) {
          const price = parseFloat(msg.data.lastPrice);
          if (price > 0) {
            $('inUsdt').value = price.toFixed(2);
            calculateAll();
          }
        }
      } catch(err) {}
    };

    S.ws.onclose = () => {
      setConnection('off', 'Desconectado');
      $('priceBadge').textContent = 'OFFLINE';
      $('priceBadge').className = 'sect-badge manual';
      if (S.wsRetries < 5) {
        S.wsRetries++;
        setTimeout(connectWebSocket, 3000 * S.wsRetries);
      }
    };

    S.ws.onerror = () => {
      setConnection('off', 'Erro WS');
    };
  } catch(e) {
    setConnection('off', 'WS indispon√≠vel');
  }
}

function setConnection(state, text) {
  $('connDot').className = 'conn-dot ' + state;
  $('connText').textContent = text;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let riskChart, scenChart, klineChart;
const chartFont = { family: "'Space Mono', monospace", size: 10 };
const gridClr = 'rgba(42,54,80,.4)';

function initCharts() {
  riskChart = new Chart($('riskChart').getContext('2d'), {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Pre√ßo BTC (BRL)', data: [], borderColor: '#f0b90b', backgroundColor: 'rgba(240,185,11,.06)', fill: true, tension: .4, borderWidth: 2, pointRadius: 0 },
      { label: 'Liquida√ß√£o', data: [], borderColor: '#ff3b5c', backgroundColor: 'rgba(255,59,92,.04)', fill: true, borderDash: [6,3], borderWidth: 1.5, pointRadius: 0 },
      { label: 'Alerta Trava', data: [], borderColor: '#ff9f43', borderDash: [3,3], borderWidth: 1, pointRadius: 0, fill: false }
    ]},
    options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#64748b', font: chartFont, boxWidth: 10, padding: 14 } },
        tooltip: { backgroundColor: '#111722', titleFont: chartFont, bodyFont: chartFont, borderColor: '#283650', borderWidth: 1,
          callbacks: { label: c => c.dataset.label + ': R$ ' + fmt(c.parsed.y) }
        }
      },
      scales: {
        x: { ticks: { color: '#3a4d6e', font: chartFont, maxTicksLimit: 8 }, grid: { color: gridClr } },
        y: { ticks: { color: '#3a4d6e', font: chartFont, callback: v => 'R$' + (v/1e3).toFixed(0) + 'k' }, grid: { color: gridClr } }
      }
    }
  });

  // scenChart removed ‚Äî stress test data now feeds into simChart
  scenChart = null;
  window._stressTestData = []; // store for consolidated chart

  klineChart = new Chart($('klineChart').getContext('2d'), {
    type: 'line',
    data: { labels: [], datasets: [{
      data: [], borderColor: '#f0b90b', backgroundColor: 'rgba(240,185,11,.08)', fill: true, tension: .3, borderWidth: 1.5, pointRadius: 0
    }]},
    options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: {
        x: { display: false },
        y: { display: false }
      }
    }
  });
}

function updateKlineChart() {
  if (!S.klineData.length) return;
  const labels = S.klineData.map(k => {
    const d = new Date(parseInt(k[0]));
    return d.getHours().toString().padStart(2,'0') + ':00';
  });
  const closes = S.klineData.map(k => parseFloat(k[4]));
  const first = closes[0], last = closes[closes.length-1];
  const color = last >= first ? '#00e68a' : '#ff3b5c';
  const bgColor = last >= first ? 'rgba(0,230,138,.08)' : 'rgba(255,59,92,.08)';

  klineChart.data.labels = labels;
  klineChart.data.datasets[0].data = closes;
  klineChart.data.datasets[0].borderColor = color;
  klineChart.data.datasets[0].backgroundColor = bgColor;
  klineChart.update('none');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRICE LOCKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleLock(type) {
  S.locks[type] = !S.locks[type];
  const btn = $(`lock${type.charAt(0).toUpperCase()+type.slice(1)}Btn`);
  const card = $(`lock${type.charAt(0).toUpperCase()+type.slice(1)}Card`);
  btn.textContent = S.locks[type] ? 'üîí ON' : 'OFF';
  btn.classList.toggle('active', S.locks[type]);
  card.classList.toggle('active', S.locks[type]);
  if (S.locks[type]) {
    if (type === 'btc') lockCurrent('btc');
    if (type === 'usdt') lockCurrent('usdt');
    addAlert('info', `Trava ${type.toUpperCase()} ${S.locks[type] ? 'ativada' : 'desativada'}`);
  }
  calculateAll();
}

function lockCurrent(type) {
  if (type === 'btc') $('lockBtcPrice').value = $('inBtc').value;
  if (type === 'usdt') $('lockUsdtPrice').value = $('inUsdt').value;
}

function checkLocks(btcUsdt, usdtBrl, effectiveLtv) {
  // BTC Lock
  if (S.locks.btc) {
    const locked = parseFloat($('lockBtcPrice').value) || 0;
    const threshold = parseFloat($('lockBtcPct').value) || 5;
    if (locked > 0) {
      const delta = ((btcUsdt - locked) / locked) * 100;
      const el = $('lockBtcDelta');
      el.textContent = (delta >= 0 ? '‚Üë +' : '‚Üì ') + delta.toFixed(2) + '% vs trava';
      el.className = 'lock-delta ' + (delta >= 0 ? 'up' : 'down');
      if (Math.abs(delta) > threshold) {
        addAlert(delta < 0 ? 'danger' : 'ok',
          `BTC ${delta < 0 ? 'caiu' : 'subiu'} ${Math.abs(delta).toFixed(1)}% vs trava de ‚ÇÆ${fmt(locked)} ‚Äî Atual: ‚ÇÆ${fmt(btcUsdt)}`);
      }
    }
  } else {
    $('lockBtcDelta').textContent = '';
  }

  // USDT Lock
  if (S.locks.usdt) {
    const locked = parseFloat($('lockUsdtPrice').value) || 0;
    const threshold = parseFloat($('lockUsdtPct').value) || 3;
    if (locked > 0) {
      const delta = ((usdtBrl - locked) / locked) * 100;
      const el = $('lockUsdtDelta');
      el.textContent = (delta >= 0 ? '‚Üë +' : '‚Üì ') + delta.toFixed(2) + '% vs trava';
      el.className = 'lock-delta ' + (delta >= 0 ? 'up' : 'down');
      if (Math.abs(delta) > threshold) {
        addAlert(delta < 0 ? 'warn' : 'ok',
          `USDT/BRL ${delta < 0 ? 'caiu' : 'subiu'} ${Math.abs(delta).toFixed(1)}% vs trava de R$${locked.toFixed(2)}`);
      }
    }
  } else {
    $('lockUsdtDelta').textContent = '';
  }

  // Collateral Lock
  if (S.locks.col) {
    const maxLtv = parseFloat($('lockColMax').value) || 70;
    const el = $('lockColDelta');
    if (effectiveLtv > maxLtv) {
      el.textContent = `‚ö† LTV ${effectiveLtv.toFixed(1)}% > limite ${maxLtv}%`;
      el.className = 'lock-delta down';
      addAlert('danger', `LTV efetivo ${effectiveLtv.toFixed(1)}% ultrapassou trava de ${maxLtv}%! Adicione colateral.`);
    } else {
      el.textContent = `‚úì LTV ${effectiveLtv.toFixed(1)}% dentro do limite`;
      el.className = 'lock-delta up';
    }
  } else {
    $('lockColDelta').textContent = '';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addAlert(type, msg) {
  const now = new Date();
  const t = now.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const last = S.alerts[0];
  if (last && last.msg === msg && (now - last.ts) < 3000) return;
  S.alerts.unshift({ type, msg, time: t, ts: now });
  if (S.alerts.length > 80) S.alerts.pop();
  renderAlerts();
  showStrip(type, msg);
  if (S.sound && (type === 'danger' || type === 'warn')) beep(type);
}

function renderAlerts() {
  const el = $('alertLog');
  $('aCount').textContent = S.alerts.length;
  if (!S.alerts.length) { el.innerHTML = '<div class="empty-state">Nenhum alerta</div>'; return; }
  el.innerHTML = S.alerts.slice(0, 40).map(a => `
    <div class="alert-item"><div class="a-dot ${a.type}"></div><div class="a-body"><div class="a-msg">${a.msg}</div><div class="a-time">${a.time}</div></div></div>
  `).join('');
}

function clearAlerts() { S.alerts = []; renderAlerts(); }

function showStrip(type, text) {
  const s = $('alertStrip');
  const map = { danger: 'danger', warn: 'warn', ok: 'ok', info: 'ok' };
  const icons = { danger: 'üö®', warn: '‚ö†Ô∏è', ok: '‚úÖ', info: '‚ÑπÔ∏è' };
  s.className = 'alert-strip show ' + (map[type] || 'ok');
  $('stripIcon').textContent = icons[type] || '';
  $('stripText').textContent = text;
  setTimeout(() => s.classList.remove('show'), 5000);
}

function beep(type) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = type === 'danger' ? 880 : 660;
    o.type = type === 'danger' ? 'square' : 'sine';
    g.gain.setValueAtTime(.08, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(.001, ctx.currentTime + .25);
    o.start(); o.stop(ctx.currentTime + .25);
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN CALCULATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let loanType = 'flexible';
function setLoanType(type) {
  loanType = type;
  $('btnFlexible').style.background = type === 'flexible' ? 'var(--gold-10)' : 'var(--steel)';
  $('btnFlexible').style.borderColor = type === 'flexible' ? 'var(--gold)' : 'var(--edge)';
  $('btnFlexible').style.color = type === 'flexible' ? 'var(--gold)' : 'var(--silver)';
  $('btnFixed').style.background = type === 'fixed' ? 'var(--gold-10)' : 'var(--steel)';
  $('btnFixed').style.borderColor = type === 'fixed' ? 'var(--gold)' : 'var(--edge)';
  $('btnFixed').style.color = type === 'fixed' ? 'var(--gold)' : 'var(--silver)';
  calculateAll();
}

function calcInterest(principal, aprPct, days, type) {
  const hourlyRate = (aprPct / 100) / 8760; // 365 * 24
  const hours = days * 24;
  let totalDebt;
  if (type === 'flexible') {
    // Compound hourly: debt = principal √ó (1 + hourlyRate)^hours
    totalDebt = principal * Math.pow(1 + hourlyRate, hours);
  } else {
    // Fixed: simple interest charged upfront
    totalDebt = principal * (1 + (aprPct / 100) * (days / 365));
  }
  const interest = totalDebt - principal;
  return { interest, totalDebt, hourlyRate, dailyCost: interest / days };
}

function calculateAll() {
  const btcUsdt = parseFloat($('inBtc').value) || 0;
  const usdtBrl = parseFloat($('inUsdt').value) || 0;
  const loan = parseFloat($('inLoan').value) || 0;
  const ltv = parseFloat($('inLtv').value) / 100;
  const apr = parseFloat($('inApr').value) || 0;
  const days = parseFloat($('inDays').value) || 90;
  if (!btcUsdt || !usdtBrl || !loan) return;

  // ‚îÄ‚îÄ Interest Calculation ‚îÄ‚îÄ
  const loanUsdt = loan / usdtBrl;
  const { interest, totalDebt, hourlyRate, dailyCost } = calcInterest(loanUsdt, apr, days, loanType);
  const interestBrl = interest * usdtBrl;
  const totalDebtBrl = totalDebt * usdtBrl;
  const dailyCostBrl = dailyCost * usdtBrl;
  const hourlyCostBrl = (loanUsdt * hourlyRate) * usdtBrl;

  // ‚îÄ‚îÄ Core Calculations (using totalDebt instead of loan) ‚îÄ‚îÄ
  const btcBrl = btcUsdt * usdtBrl;
  const spread = ((usdtBrl - 5.70) / 5.70) * 100;
  const colBrl = loan / ltv; // Collateral required at entry (based on principal)
  const colUsdt = colBrl / usdtBrl;
  const btcNeeded = colUsdt / btcUsdt;

  // Safety & liquidation now consider accumulated interest
  const safetyVsDebt = colBrl - totalDebtBrl;
  const safetyPct = (safetyVsDebt / colBrl) * 100;
  const effectiveLtv = (totalDebtBrl / colBrl) * 100;

  // Bybit liquidation: uses 92% LTV and includes interest
  const BYBIT_LIQ_LTV = 0.92;
  const BYBIT_MARGIN_CALL_LTV = 0.85;
  const liqPriceBrl = totalDebtBrl / (btcNeeded * BYBIT_LIQ_LTV);
  const liqPriceUsdt = liqPriceBrl / usdtBrl;
  const marginCallPriceBrl = totalDebtBrl / (btcNeeded * BYBIT_MARGIN_CALL_LTV);
  const maxDrop = ((btcBrl - liqPriceBrl) / btcBrl) * 100;
  const marginCallDrop = ((btcBrl - marginCallPriceBrl) / btcBrl) * 100;
  const dist = ((btcBrl - liqPriceBrl) / btcBrl) * 100;
  const health = Math.max(0, Math.min(100, dist * 1.8));

  // ‚îÄ‚îÄ Interest Preview Panel ‚îÄ‚îÄ
  $('fApr').textContent = apr.toFixed(1) + '% a.a.';
  $('fDays').textContent = days + ' dias';
  $('prevInterest').textContent = 'R$ ' + fmt(interestBrl);
  $('prevDebt').textContent = 'R$ ' + fmt(totalDebtBrl);
  $('prevHourly').textContent = 'R$ ' + hourlyCostBrl.toFixed(2) + '/hora';
  $('prevDaily').textContent = 'R$ ' + fmt(dailyCostBrl) + '/dia';
  $('prevLiqReal').textContent = '‚ÇÆ ' + fmt(liqPriceUsdt);

  // ‚îÄ‚îÄ Field displays ‚îÄ‚îÄ
  $('fBtc').textContent = '‚ÇÆ ' + fmt(btcUsdt);
  $('fUsdt').textContent = 'R$ ' + usdtBrl.toFixed(2);
  $('fLoan').textContent = 'R$ ' + fmt(loan);
  $('fLtv').textContent = (ltv * 100).toFixed(0) + '%';

  // ‚îÄ‚îÄ Health (now based on debt including interest) ‚îÄ‚îÄ
  let hColor, hText, hBg;
  if (health >= 65) { hColor = 'var(--green)'; hText = 'SAUD√ÅVEL'; hBg = 'var(--green-20)'; }
  else if (health >= 35) { hColor = 'var(--orange)'; hText = 'ATEN√á√ÉO'; hBg = 'var(--orange-20)'; }
  else { hColor = 'var(--red)'; hText = 'PERIGO'; hBg = 'var(--red-20)'; }
  $('healthScore').textContent = Math.round(health);
  $('healthScore').style.color = hColor;
  $('healthLabel').textContent = hText;
  $('healthLabel').style.background = hBg;
  $('healthLabel').style.color = hColor;
  $('healthFill').style.width = health + '%';
  $('healthFill').style.background = `linear-gradient(90deg, var(--red), var(--orange) 40%, var(--green))`;

  // ‚îÄ‚îÄ Metrics ‚îÄ‚îÄ
  $('mBtc').textContent = btcNeeded.toFixed(6);
  $('mBtcSub').textContent = '‚âà ‚ÇÆ' + fmtK(colUsdt);
  $('mUsdt').textContent = '‚ÇÆ' + fmtK(colUsdt);
  $('mUsdtSub').textContent = 'D√≠vida: ‚ÇÆ' + fmtK(totalDebt);
  $('mBrl').textContent = 'R$' + fmtK(colBrl);
  $('mBrlSub').textContent = 'Juros R$' + fmtK(interestBrl) + ' em ' + days + 'd';
  $('mLiq').textContent = '‚ÇÆ' + fmtK(liqPriceUsdt);
  $('mLiqSub').textContent = '‚Üì ' + maxDrop.toFixed(1) + '% at√© liq. (92%)';

  // ‚îÄ‚îÄ Risk info ‚îÄ‚îÄ
  $('riskInfo').textContent = 'Queda m√°x ' + maxDrop.toFixed(1) + '% | Margin Call ' + marginCallDrop.toFixed(1) + '% | Juros R$' + fmtK(interestBrl);

  // ‚îÄ‚îÄ Breakdown ‚îÄ‚îÄ
  $('bdBtc').textContent = btcNeeded.toFixed(6) + ' BTC';
  $('bdBtcS').textContent = '‚âà US$ ' + fmt(colUsdt);
  $('bdUsdt').textContent = '‚ÇÆ ' + fmt(colUsdt);
  $('bdUsdtS').textContent = 'D√≠vida ‚ÇÆ' + fmt(totalDebt) + ' (P+J)';
  $('bdBrl').textContent = 'R$ ' + fmt(colBrl);
  $('bdBrlS').textContent = 'Juros ' + days + 'd: R$' + fmt(interestBrl);
  $('bdBuf').textContent = 'R$ ' + fmt(safetyVsDebt);
  $('bdBufS').textContent = safetyPct.toFixed(1) + '% buffer (c/ juros)';

  // ‚îÄ‚îÄ Sidebar stats ‚îÄ‚îÄ
  $('sBtcBrl').textContent = 'R$' + fmtK(btcBrl);
  $('sSpread').textContent = (spread >= 0 ? '+' : '') + spread.toFixed(2) + '%';
  $('sSpread').style.color = spread > 2 ? 'var(--orange)' : 'var(--green)';
  $('sMaxDrop').textContent = maxDrop.toFixed(1) + '%';
  $('sMaxDrop').style.color = maxDrop < 20 ? 'var(--red)' : maxDrop < 35 ? 'var(--orange)' : 'var(--green)';
  $('sBuffer').textContent = 'R$' + fmtK(safetyVsDebt);

  // 24h stats from ticker
  if (S.ticker24.high) $('kH').textContent = '‚ÇÆ' + fmtK(S.ticker24.high);
  if (S.ticker24.low) $('kL').textContent = '‚ÇÆ' + fmtK(S.ticker24.low);
  if (S.ticker24.vol) $('kV').textContent = fmtK(S.ticker24.vol) + ' BTC';
  if (S.ticker24.pct) {
    const p = S.ticker24.pct;
    $('k24').textContent = (p >= 0 ? '+' : '') + p.toFixed(2) + '%';
    $('k24').style.color = p >= 0 ? 'var(--green)' : 'var(--red)';
  }

  // ‚îÄ‚îÄ Charts ‚îÄ‚îÄ
  updateRiskChart(btcBrl, liqPriceBrl, marginCallPriceBrl);
  updateScenarios(btcUsdt, usdtBrl, loan, ltv, btcNeeded, totalDebtBrl);

  // ‚îÄ‚îÄ Locks ‚îÄ‚îÄ
  checkLocks(btcUsdt, usdtBrl, effectiveLtv);

  // ‚îÄ‚îÄ Alert logic ‚îÄ‚îÄ
  if (S.prev.health !== null) {
    if (health < 25 && S.prev.health >= 25) addAlert('danger', `üö® CR√çTICO! Sa√∫de caiu para ${health.toFixed(0)}. Risco de liquida√ß√£o iminente!`);
    else if (health < 40 && S.prev.health >= 40) addAlert('warn', `Sa√∫de em ${health.toFixed(0)} ‚Äî BTC aguenta queda de ${maxDrop.toFixed(1)}% antes de liquida√ß√£o`);
    else if (health >= 65 && S.prev.health < 65) addAlert('ok', `Colateral saud√°vel! Score ${health.toFixed(0)}, margem R$${fmt(safetyVsDebt)}`);
  }

  if (maxDrop < 12) addAlert('danger', `BTC s√≥ aguenta -${maxDrop.toFixed(1)}% antes de liquida√ß√£o!`);
  else if (maxDrop < 20 && (!S.prev.health || S.prev.health >= 40)) addAlert('warn', `Queda m√°xima suportada: ${maxDrop.toFixed(1)}%`);

  if (effectiveLtv > 80) addAlert('danger', `LTV efetivo ${effectiveLtv.toFixed(1)}% (c/ juros) ‚Äî acima do inicial Bybit de 80%!`);

  S.prev.health = health;
  S.prev.btcPrice = btcUsdt;
  S.prev.usdtPrice = usdtBrl;
}

function updateRiskChart(price, liqPrice, marginCallPrice) {
  const labels = [], prices = [], liqLine = [], alertLine = [], mcLine = [];
  const alertPrice = S.locks.btc ? (parseFloat($('lockBtcPrice').value) || 0) * (parseFloat($('inUsdt').value) || 1) : 0;

  for (let i = -40; i <= 40; i += 5) {
    labels.push((i >= 0 ? '+' : '') + i + '%');
    prices.push(price * (1 + i / 100));
    liqLine.push(liqPrice);
    mcLine.push(marginCallPrice || null);
    alertLine.push(alertPrice > 0 ? alertPrice : null);
  }
  riskChart.data.labels = labels;
  riskChart.data.datasets[0].data = prices;
  riskChart.data.datasets[1].data = liqLine;
  riskChart.data.datasets[2].data = alertLine;
  // Add margin call line if not already present
  if (riskChart.data.datasets.length < 4) {
    riskChart.data.datasets.push({ label: 'Margin Call (85%)', data: mcLine, borderColor: '#ff9f43', borderDash: [4,4], borderWidth: 1.5, pointRadius: 0, fill: false });
  } else {
    riskChart.data.datasets[3].data = mcLine;
  }
  riskChart.update('none');
}

function updateScenarios(btcUsdt, usdtBrl, loan, ltv, baseBtc, totalDebtBrl) {
  const scenarios = [
    { l: 'Crash -40%', f: .60 }, { l: 'Queda -30%', f: .70 }, { l: 'Queda -20%', f: .80 },
    { l: 'Queda -10%', f: .90 }, { l: '‚ñ∏ ATUAL', f: 1, cur: true },
    { l: 'Alta +10%', f: 1.10 }, { l: 'Alta +20%', f: 1.20 }, { l: 'Alta +30%', f: 1.30 }, { l: 'Bull +50%', f: 1.50 }
  ];

  const body = $('scenBody');
  body.innerHTML = '';
  const cL = [], cD = [], cBg = [], cBd = [];
  const debt = totalDebtBrl || loan; // fallback
  window._stressTestData = []; // reset

  scenarios.forEach(s => {
    const sBtc = btcUsdt * s.f;
    const sBrl = sBtc * usdtBrl;
    const colBrl = loan / ltv;
    const colUsdt = colBrl / usdtBrl;
    const sBtcNeeded = colUsdt / sBtc;
    const newColVal = baseBtc * sBtc * usdtBrl;
    const effLtv = (debt / newColVal) * 100;
    const liqPriceScen = debt / (baseBtc * 0.92);
    const sDrop = ((sBrl - liqPriceScen) / sBrl) * 100;

    let risk, rc;
    if (effLtv >= 92) { risk = 'LIQUIDA√á√ÉO'; rc = 'liq'; }
    else if (effLtv >= 85) { risk = 'MARGIN CALL'; rc = 'danger'; }
    else if (effLtv >= 65) { risk = 'ATEN√á√ÉO'; rc = 'caution'; }
    else { risk = 'SEGURO'; rc = 'safe'; }

    const tr = document.createElement('tr');
    if (s.cur) tr.className = 'current';
    tr.innerHTML = `<td><strong>${s.l}</strong></td><td>‚ÇÆ${fmt(sBtc)}</td><td>R$${fmtK(sBrl)}</td><td>${sBtcNeeded.toFixed(6)}</td><td>${effLtv.toFixed(1)}%</td><td>${sDrop > 0 ? sDrop.toFixed(1) + '%' : '‚Äî'}</td><td><span class="risk-badge ${rc}">${risk}</span></td>`;
    body.appendChild(tr);

    cL.push(s.l.replace('‚ñ∏ ', ''));
    cD.push(sBtcNeeded);
    cBg.push(s.f >= 1 ? 'rgba(0,230,138,.4)' : 'rgba(255,59,92,.4)');
    cBd.push(s.f >= 1 ? '#00e68a' : '#ff3b5c');
    // Store for consolidated chart
    window._stressTestData.push({ label: s.l.replace('‚ñ∏ ', ''), btcNeeded: sBtcNeeded, ltvPct: effLtv, btcUsdt: sBtc, usdtBrl: usdtBrl });
  });

  // Store stress test chart data globally for consolidated chart
  window._stressLabels = cL;
  window._stressData = cD;
  window._stressBg = cBg;
  window._stressBd = cBd;
  // Trigger simChart update to include stress data
  if (simChart && simRows.length > 0) simCalculate();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT LISTENERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
['inBtc','inUsdt','inLoan','inApr','inDays'].forEach(id => $(id).addEventListener('input', calculateAll));
$('inLtv').addEventListener('input', calculateAll);

$('btnSound').addEventListener('click', () => {
  S.sound = !S.sound;
  $('btnSound').textContent = S.sound ? 'üîî' : 'üîï';
  $('btnSound').classList.toggle('active', S.sound);
});

$('btnAutoRefresh').addEventListener('click', () => {
  S.autoRefresh = !S.autoRefresh;
  $('btnAutoRefresh').classList.toggle('active', S.autoRefresh);
  if (S.autoRefresh) {
    fetchAllPrices();
    S.autoTimer = setInterval(fetchAllPrices, 15000);
    addAlert('info', 'Auto-refresh ativado (15s)');
  } else {
    clearInterval(S.autoTimer);
    addAlert('info', 'Auto-refresh desativado');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRICE SIMULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let simChart;
let simRows = [];
let simIdCounter = 0;

function initSimChart() {
  const ctx = $('simChart').getContext('2d');

  // Threshold line plugin
  const thresholdPlugin = {
    id: 'thresholds',
    afterDraw(chart) {
      const { ctx, chartArea, scales } = chart;
      if (!scales.y1) return;
      const drawLine = (val, color, label) => {
        const y = scales.y1.getPixelForValue(val);
        if (y < chartArea.top || y > chartArea.bottom) return;
        ctx.save();
        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(chartArea.left, y);
        ctx.lineTo(chartArea.right, y);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = color;
        ctx.font = 'bold 9px "Space Mono"';
        ctx.textAlign = 'right';
        ctx.fillText(label, chartArea.right - 4, y - 4);
        ctx.restore();
      };
      drawLine(85, '#ff9f43', '‚ö† MARGIN CALL 85%');
      drawLine(92, '#ff3b5c', 'üíÄ LIQUIDA√á√ÉO 92%');
    }
  };

  simChart = new Chart(ctx, {
    type: 'bar',
    plugins: [thresholdPlugin],
    data: {
      labels: [],
      datasets: [
        {
          label: 'BTC Simulado',
          data: [],
          backgroundColor: [],
          borderColor: [],
          borderWidth: 1.5,
          borderRadius: 5,
          yAxisID: 'y',
          order: 2
        },
        {
          label: 'BTC Stress Test',
          data: [],
          backgroundColor: 'rgba(77,166,255,0.35)',
          borderColor: 'rgba(77,166,255,0.8)',
          borderWidth: 1.5,
          borderRadius: 5,
          yAxisID: 'y',
          order: 3
        },
        {
          label: 'LTV Bybit %',
          data: [],
          type: 'line',
          borderColor: '#a78bfa',
          backgroundColor: 'rgba(167,139,250,0.08)',
          borderWidth: 2.5,
          pointRadius: 5,
          pointBackgroundColor: [],
          pointBorderColor: '#a78bfa',
          pointBorderWidth: 2,
          tension: 0.3,
          fill: true,
          yAxisID: 'y1',
          order: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: { color: '#64748b', font: chartFont, boxWidth: 12, padding: 16, usePointStyle: false }
        },
        tooltip: {
          backgroundColor: '#0c1018', titleFont: chartFont, bodyFont: chartFont,
          borderColor: '#283650', borderWidth: 1, padding: 12,
          callbacks: {
            title: ctx => ctx[0]?.label || '',
            label: function(ctx) {
              if (ctx.datasetIndex === 0) return '  üü° Simulado: ' + ctx.parsed.y.toFixed(6) + ' BTC';
              if (ctx.datasetIndex === 1) return '  üîµ Stress: ' + ctx.parsed.y.toFixed(6) + ' BTC';
              if (ctx.datasetIndex === 2) {
                const v = ctx.parsed.y;
                const icon = v >= 92 ? 'üíÄ' : v >= 85 ? '‚ö†' : v >= 65 ? 'üü°' : '‚úÖ';
                return '  ' + icon + ' LTV: ' + v.toFixed(1) + '%';
              }
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#3a4d6e', font: chartFont, maxRotation: 45 },
          grid: { display: false }
        },
        y: {
          position: 'left',
          ticks: { color: '#64748b', font: chartFont, callback: v => v.toFixed(4) },
          grid: { color: 'rgba(40,54,80,.3)' },
          title: { display: true, text: 'BTC Necess√°rio', color: '#f0b90b', font: { ...chartFont, weight: 'bold' } }
        },
        y1: {
          position: 'right',
          min: 0, max: 120,
          ticks: {
            color: '#a78bfa', font: chartFont,
            callback: v => v + '%',
            stepSize: 20
          },
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'LTV Bybit %', color: '#a78bfa', font: { ...chartFont, weight: 'bold' } }
        }
      }
    }
  });
}

function simAddRow(btcPrice, usdtPrice) {
  const id = simIdCounter++;
  const btc = btcPrice || parseFloat($('inBtc').value) || 100000;
  const usdt = usdtPrice || parseFloat($('inUsdt').value) || 5.24;
  simRows.push({ id, btc: Math.round(btc), usdt: parseFloat(usdt.toFixed(2)) });
  simRenderRows();
  simCalculate();
}

function simRemoveRow(id) {
  simRows = simRows.filter(r => r.id !== id);
  simRenderRows();
  simCalculate();
}

function simRenderRows() {
  const container = $('simRows');
  container.innerHTML = simRows.map(r => `
    <div class="sim-row" id="simRow_${r.id}" data-id="${r.id}" style="grid-template-columns:120px 90px 100px 110px 100px 100px 90px 40px">
      <div class="sim-cell"><input type="number" class="sim-inp" id="simBtc_${r.id}" value="${r.btc}" step="100" onchange="simOnChange(${r.id})" oninput="simOnChange(${r.id})"></div>
      <div class="sim-cell"><input type="number" class="sim-inp usdt-inp" id="simUsdt_${r.id}" value="${r.usdt}" step="0.01" onchange="simOnChange(${r.id})" oninput="simOnChange(${r.id})" style="font-size:11px"></div>
      <div class="sim-cell" id="simBrl_${r.id}">--</div>
      <div class="sim-cell" id="simBtcNeed_${r.id}" style="font-weight:700;color:var(--gold)">--</div>
      <div class="sim-cell" id="simDelta_${r.id}">--</div>
      <div class="sim-cell" id="simColBrl_${r.id}">--</div>
      <div class="sim-cell" id="simLtv_${r.id}">--</div>
      <div class="sim-cell"><button class="sim-remove" onclick="simRemoveRow(${r.id})" title="Remover">‚úï</button></div>
    </div>
  `).join('');
  $('simCount').textContent = simRows.length + ' cen√°rio' + (simRows.length !== 1 ? 's' : '');
}

function simOnChange(id) {
  const row = simRows.find(r => r.id === id);
  if (!row) return;
  const btcInp = $('simBtc_' + id);
  const usdtInp = $('simUsdt_' + id);
  if (btcInp) row.btc = parseFloat(btcInp.value) || 0;
  if (usdtInp) row.usdt = parseFloat(usdtInp.value) || 0;
  simCalculate();
}

function simCalculate() {
  const currentBtcUsdt = parseFloat($('inBtc').value) || 0;
  const currentUsdtBrl = parseFloat($('inUsdt').value) || 0;
  const loan = parseFloat($('inLoan').value) || 0;
  const ltvTarget = parseFloat($('inLtv').value) / 100;
  const apr = parseFloat($('inApr').value) || 0;
  const days = parseFloat($('inDays').value) || 90;
  if (!currentBtcUsdt || !currentUsdtBrl || !loan) return;

  // ‚îÄ‚îÄ Current position (real) ‚îÄ‚îÄ
  // Loan was taken in USDT at current USDT/BRL rate
  const loanUsdt = loan / currentUsdtBrl;
  const { totalDebt: debtUsdt } = calcInterest(loanUsdt, apr, days, loanType);
  
  // Current BTC locked = (loan / ltvTarget) / (btcUsdt * usdtBrl) converted to BTC
  const currentColUsdt = loan / (ltvTarget * currentUsdtBrl);
  const currentBtcLocked = currentColUsdt / currentBtcUsdt;
  const currentColBrl = currentBtcLocked * currentBtcUsdt * currentUsdtBrl;

  // Bybit liquidation price (only BTC/USDT matters, LTV 92%)
  const BYBIT_LIQ_LTV = 0.92;
  const liqPriceUsdt = debtUsdt / (currentBtcLocked * BYBIT_LIQ_LTV);

  // Update summary ‚Äî current position
  $('simCurrent').textContent = currentBtcLocked.toFixed(6) + ' BTC';
  $('simCurrentSub').textContent = 'Col R$' + fmtK(currentColBrl) + ' ¬∑ LTV ' + (ltvTarget * 100).toFixed(0) + '%';
  $('simLiqPrice').textContent = '‚ÇÆ ' + fmt(Math.round(liqPriceUsdt));

  let bestRow = null, worstRow = null;
  let bestLtv = Infinity, worstLtv = -Infinity;

  // Sort by BTC price for chart
  const sorted = [...simRows].sort((a, b) => a.btc - b.btc);

  sorted.forEach(row => {
    if (row.btc <= 0 || row.usdt <= 0) return;

    // ‚îÄ‚îÄ KEY CALCULATIONS ‚îÄ‚îÄ
    // How many BTC needed to maintain target LTV at simulated prices
    // BTC needed = debtUsdt / (ltvTarget * simBtcUsdt)
    const btcNeeded = debtUsdt / (ltvTarget * row.btc);

    // Delta vs current locked BTC (positive = needs MORE, bad)
    const deltaBtc = btcNeeded - currentBtcLocked;

    // Collateral value in BRL at simulated prices (for current locked BTC)
    const simColBrl = currentBtcLocked * row.btc * row.usdt;

    // BTC/BRL price
    const btcBrl = row.btc * row.usdt;

    // LTV Bybit (what actually matters for liquidation) ‚Äî only BTC/USDT
    const ltvBybit = (debtUsdt / (currentBtcLocked * row.btc)) * 100;

    // Track best/worst by LTV
    if (ltvBybit < bestLtv) { bestLtv = ltvBybit; bestRow = { ...row, btcNeeded, ltvBybit, simColBrl }; }
    if (ltvBybit > worstLtv) { worstLtv = ltvBybit; worstRow = { ...row, btcNeeded, ltvBybit, simColBrl }; }

    // ‚îÄ‚îÄ UPDATE ROW CELLS ‚îÄ‚îÄ
    const rowEl = $('simRow_' + row.id);
    if (rowEl) {
      rowEl.className = 'sim-row ' + (deltaBtc <= 0 ? 'positive' : 'negative');
    }

    const brlEl = $('simBrl_' + row.id);
    if (brlEl) brlEl.textContent = 'R$' + fmtK(btcBrl);

    const needEl = $('simBtcNeed_' + row.id);
    if (needEl) needEl.textContent = btcNeeded.toFixed(6);

    const deltaEl = $('simDelta_' + row.id);
    if (deltaEl) {
      if (Math.abs(deltaBtc) < 0.000001) {
        deltaEl.innerHTML = '<span style="color:var(--ash)">‚Äî</span>';
      } else {
        const sign = deltaBtc > 0 ? '+' : '';
        const color = deltaBtc > 0 ? 'var(--red)' : 'var(--green)';
        deltaEl.innerHTML = `<span style="color:${color};font-weight:700">${sign}${deltaBtc.toFixed(6)}</span>`;
      }
    }

    const colEl = $('simColBrl_' + row.id);
    if (colEl) {
      colEl.textContent = 'R$' + fmtK(simColBrl);
      colEl.style.color = simColBrl >= loan / ltvTarget ? 'var(--green)' : 'var(--red)';
    }

    const ltvEl = $('simLtv_' + row.id);
    if (ltvEl) {
      ltvEl.textContent = ltvBybit.toFixed(1) + '%';
      if (ltvBybit >= 92) { ltvEl.className = 'sim-cell sim-ltv danger'; ltvEl.innerHTML = '<span class="risk-badge liq">' + ltvBybit.toFixed(1) + '% üíÄ</span>'; }
      else if (ltvBybit >= 85) { ltvEl.className = 'sim-cell sim-ltv danger'; ltvEl.innerHTML = '<span class="risk-badge danger">' + ltvBybit.toFixed(1) + '%</span>'; }
      else if (ltvBybit >= 65) { ltvEl.className = 'sim-cell sim-ltv caution'; }
      else { ltvEl.className = 'sim-cell sim-ltv safe'; }
    }

    // (chart data handled in consolidated section below)
  });

  // Update summary ‚Äî best/worst
  if (bestRow) {
    $('simBest').textContent = bestRow.btcNeeded.toFixed(6) + ' BTC';
    $('simBest').style.color = 'var(--green)';
    $('simBestSub').textContent = 'LTV ' + bestRow.ltvBybit.toFixed(1) + '% ¬∑ Col R$' + fmtK(bestRow.simColBrl);
  }
  if (worstRow) {
    $('simWorst').textContent = worstRow.btcNeeded.toFixed(6) + ' BTC';
    $('simWorst').style.color = worstRow.ltvBybit >= 85 ? 'var(--red)' : 'var(--orange)';
    $('simWorstSub').textContent = 'LTV ' + worstRow.ltvBybit.toFixed(1) + '% ¬∑ Col R$' + fmtK(worstRow.simColBrl);
  }

  // ‚ïê‚ïê‚ïê UPDATE CONSOLIDATED CHART ‚Äî Power BI Style ‚ïê‚ïê‚ïê
  if (simChart) {
    // Merge simulator data + stress test data into unified chart
    const allPoints = [];

    // Add simulator scenarios
    sorted.forEach(row => {
      if (row.btc <= 0 || row.usdt <= 0) return;
      const btcNeeded = debtUsdt / (ltvTarget * row.btc);
      const ltvBybit = (debtUsdt / (currentBtcLocked * row.btc)) * 100;
      allPoints.push({
        label: '‚ÇÆ' + fmtK(row.btc) + '\nR$' + row.usdt.toFixed(2),
        sortKey: row.btc,
        simBtc: btcNeeded,
        stressBtc: null,
        ltv: ltvBybit,
        source: 'sim'
      });
    });

    // Add stress test scenarios (if available)
    const stressData = window._stressTestData || [];
    stressData.forEach(s => {
      // Check if a similar BTC price already exists from simulator
      const exists = allPoints.find(p => Math.abs(p.sortKey - s.btcUsdt) / s.btcUsdt < 0.02);
      if (exists) {
        // Merge into existing point
        exists.stressBtc = s.btcNeeded;
        if (!exists.label.includes(s.label)) exists.label += '\n' + s.label;
      } else {
        allPoints.push({
          label: s.label + '\n‚ÇÆ' + fmtK(s.btcUsdt),
          sortKey: s.btcUsdt,
          simBtc: null,
          stressBtc: s.btcNeeded,
          ltv: s.ltvPct,
          source: 'stress'
        });
      }
    });

    // Sort all by BTC price
    allPoints.sort((a, b) => a.sortKey - b.sortKey);

    const labels = allPoints.map(p => p.label);
    const simBars = allPoints.map(p => p.simBtc);
    const stressBars = allPoints.map(p => p.stressBtc);
    const ltvLine = allPoints.map(p => p.ltv);

    // Color sim bars by LTV risk
    const simBg = allPoints.map(p => {
      if (p.simBtc === null) return 'transparent';
      const l = p.ltv;
      return l >= 92 ? 'rgba(255,59,92,.6)' : l >= 85 ? 'rgba(255,159,67,.5)' : l >= 65 ? 'rgba(240,185,11,.45)' : 'rgba(0,230,138,.45)';
    });
    const simBd = simBg.map(c => c === 'transparent' ? 'transparent' : c.replace(/[\d.]+\)$/, '1)'));

    // LTV point colors
    const ltvPointColors = allPoints.map(p => {
      const l = p.ltv;
      return l >= 92 ? '#ff3b5c' : l >= 85 ? '#ff9f43' : l >= 65 ? '#f0b90b' : '#00e68a';
    });

    simChart.data.labels = labels;
    simChart.data.datasets[0].data = simBars;
    simChart.data.datasets[0].backgroundColor = simBg;
    simChart.data.datasets[0].borderColor = simBd;
    simChart.data.datasets[1].data = stressBars;
    simChart.data.datasets[2].data = ltvLine;
    simChart.data.datasets[2].pointBackgroundColor = ltvPointColors;
    simChart.update('none');
  }
}

// ‚îÄ‚îÄ Manual Add ‚îÄ‚îÄ
function simAddManual() {
  const btc = parseFloat($('simInBtc').value);
  const usdt = parseFloat($('simInUsdt').value);
  if (!btc || btc <= 0) { $('simInBtc').focus(); return; }
  if (!usdt || usdt <= 0) { $('simInUsdt').focus(); return; }
  simAddRow(btc, usdt);
}

// ‚îÄ‚îÄ Quick % buttons ‚îÄ‚îÄ
function simAddBtcPct(pct) {
  const curBtc = parseFloat($('inBtc').value) || 100000;
  const curUsdt = parseFloat($('inUsdt').value) || 5.24;
  simAddRow(Math.round(curBtc * (1 + pct / 100)), curUsdt);
}
function simAddUsdtPct(pct) {
  const curBtc = parseFloat($('inBtc').value) || 100000;
  const curUsdt = parseFloat($('inUsdt').value) || 5.24;
  simAddRow(curBtc, parseFloat((curUsdt * (1 + pct / 100)).toFixed(2)));
}

// ‚îÄ‚îÄ Preset Scenarios ‚îÄ‚îÄ
function simLoadPreset(type) {
  const btc = parseFloat($('inBtc').value) || 100000;
  const usdt = parseFloat($('inUsdt').value) || 5.24;
  simRows = [];
  simIdCounter = 0;

  const presets = {
    bearUsdUp: [
      [btc * 0.70, usdt * 1.15],
      [btc * 0.75, usdt * 1.10],
      [btc * 0.80, usdt * 1.08],
      [btc * 0.85, usdt * 1.05],
      [btc * 0.90, usdt * 1.03],
      [btc, usdt]
    ],
    bearUsdDown: [
      [btc * 0.70, usdt * 0.90],
      [btc * 0.75, usdt * 0.92],
      [btc * 0.80, usdt * 0.95],
      [btc * 0.85, usdt * 0.97],
      [btc * 0.90, usdt * 0.98],
      [btc, usdt]
    ],
    bullUsdUp: [
      [btc, usdt],
      [btc * 1.10, usdt * 1.05],
      [btc * 1.20, usdt * 1.08],
      [btc * 1.30, usdt * 1.10],
      [btc * 1.50, usdt * 1.12],
      [btc * 2.00, usdt * 1.15]
    ],
    bullUsdDown: [
      [btc, usdt],
      [btc * 1.10, usdt * 0.97],
      [btc * 1.20, usdt * 0.95],
      [btc * 1.30, usdt * 0.92],
      [btc * 1.50, usdt * 0.90],
      [btc * 2.00, usdt * 0.85]
    ],
    matrix: [
      [btc * 0.70, usdt * 0.90],
      [btc * 0.70, usdt],
      [btc * 0.70, usdt * 1.10],
      [btc * 0.85, usdt * 0.95],
      [btc * 0.85, usdt],
      [btc * 0.85, usdt * 1.05],
      [btc, usdt * 0.90],
      [btc, usdt],
      [btc, usdt * 1.10],
      [btc * 1.20, usdt * 0.95],
      [btc * 1.20, usdt],
      [btc * 1.20, usdt * 1.05]
    ],
    worst: [
      [btc * 0.50, usdt * 0.85],
      [btc * 0.60, usdt * 0.90],
      [btc * 0.70, usdt * 0.92],
      [btc * 0.75, usdt * 0.95],
      [btc * 0.80, usdt * 0.97],
      [btc * 0.85, usdt]
    ],
    best: [
      [btc, usdt],
      [btc * 1.20, usdt * 1.05],
      [btc * 1.50, usdt * 1.10],
      [btc * 2.00, usdt * 1.15],
      [btc * 2.50, usdt * 1.20],
      [btc * 3.00, usdt * 1.25]
    ]
  };

  (presets[type] || presets.matrix).forEach(([b, u]) => {
    simRows.push({ id: simIdCounter++, btc: Math.round(b), usdt: parseFloat(u.toFixed(2)) });
  });

  simRenderRows();
  simCalculate();
}

function simReset() {
  simRows = [];
  simIdCounter = 0;
  $('simRows').innerHTML = '';
  $('simCount').textContent = '0 cen√°rios';
  if (simChart) {
    simChart.data.labels = [];
    simChart.data.datasets[0].data = [];
    simChart.data.datasets[1].data = [];
    simChart.update('none');
  }
  $('simCurrent').textContent = '--'; $('simCurrentSub').textContent = '--';
  $('simBest').textContent = '--'; $('simBestSub').textContent = '--';
  $('simWorst').textContent = '--'; $('simWorstSub').textContent = '--';
  $('simLiqPrice').textContent = '--';
}

// Hook simulator recalc to main calculation
const _origCalc = calculateAll;
calculateAll = function() {
  _origCalc();
  if (simRows.length > 0) simCalculate();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
  initCharts();
  initSimChart();
  calculateAll();
  // Try WebSocket first
  connectWebSocket();
  // Fetch REST as backup + kline data
  setTimeout(fetchAllPrices, 1500);
  // Load default preset
  simLoadPreset('correction');
  // Enter key on quick input
  $('simQuickInput').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); simQuickAdd(); }});
  // Auto-fill range from/to based on current price
  const cp = parseFloat($('inBtc').value) || 100000;
  $('simRangeFrom').value = Math.round(cp * 0.5);
  $('simRangeTo').value = Math.round(cp * 1.5);
});
</script>
</body>
</html>
